<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sector 9: FASE FINAL</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #interfaz-usuario { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; pointer-events: none; }
        .pantalla { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; pointer-events: auto;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(15px);
        }
        #hud { position: absolute; top: 20px; left: 20px; color: #0f0; font-size: 24px; display: none; text-shadow: 2px 2px #000; }
        button { padding: 20px 40px; border: 2px solid #0f0; background: transparent; color: #0f0; cursor: pointer; font-weight: bold; letter-spacing: 3px; transition: 0.2s; font-family: inherit; }
        button:hover { background: #0f0; color: #000; box-shadow: 0 0 25px #0f0; }
        #overlay-final { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; opacity: 0; pointer-events: none; z-index: 4000; transition: opacity 2s; }
        h1 { color: #0f0; letter-spacing: 15px; text-align: center; margin-bottom: 30px; }
    </style>
</head>
<body>

    <div id="overlay-final"></div>

    <div id="interfaz-usuario">
        <div id="pantalla-inicio" class="pantalla">
            <h1>SECTOR 9<br><small style="font-size: 0.4em; letter-spacing: 5px;">FASE 2: EL LABERINTO EXTENDIDO</small></h1>
            <button id="btn-comenzar">INICIAR CONEXIÓN</button>
        </div>

        <div id="pantalla-pausa" class="pantalla" style="display: none;">
            <h1>SISTEMA EN PAUSA</h1>
            <button id="btn-reanudar">REANUDAR</button>
            <button onclick="location.reload()" style="border-color: #555; color: #555; margin-top: 10px;">REINICIAR</button>
        </div>
        
        <div id="pantalla-muerte" class="pantalla" style="display: none;">
            <h1 style="color: red;">TERMINAL DESTRUIDA</h1>
            <button onclick="location.reload()">REINTENTAR</button>
        </div>

        <div id="pantalla-final" class="pantalla" style="display: none;">
            <h1 style="color: #ff0000; text-shadow: 0 0 20px red;">SECTOR COLAPSADO</h1>
            <p style="color: #fff;">CONEXIÓN PERDIDA CON EL SUJETO</p>
               <button onclick="window.location.href='index.html'">VOLVER AL INICIO</button>
        </div>

        <div id="hud">NÚCLEOS: <span id="contador">0</span> / 10</div>
    </div>

    <script src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

    <script>
        let scene, camera, renderer, controls, lantern, enemy, enemyLight, fireLight;
        let officeGroup, fireParticles = [];
        let fase = 'MENU', fusiblesEncontrados = 0, iaActiva = false;
        let finalTimer = 0, shadowEnemy;
        const UNIT = 20; 
        const walls = [], wallMeshes = [], items = [], keys = {};
        
        let iaVelocity = new THREE.Vector3(0, 0, 0);
        let iaTimer = 0;
        let iaHeading = 0;

        const mapa = [
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
            [0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0],
            [0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1,0],
            [0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,0,1,0,1,0],
            [0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,0],
            [0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0],
            [0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
            [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
        ];

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.012);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            lantern = new THREE.SpotLight(0xffffff, 15, 250, 1, 1, 1);
            scene.add(lantern); scene.add(lantern.target);

            // Luz ambiental para el incendio final
            fireLight = new THREE.AmbientLight(0xff4400, 0);
            scene.add(fireLight);

            crearOficina();

            controls = new THREE.PointerLockControls(camera, document.body);
            document.getElementById('btn-comenzar').onclick = () => { 
                fase = 'JUEGO'; 
                document.getElementById('pantalla-inicio').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                camera.position.set(15, 10, 15); 
                controls.lock();
                setTimeout(() => iaActiva = true, 3000);
            };

            document.getElementById('btn-reanudar').onclick = () => controls.lock();
            controls.addEventListener('unlock', () => { if(fase === 'JUEGO') document.getElementById('pantalla-pausa').style.display = 'flex'; });
            controls.addEventListener('lock', () => { document.getElementById('pantalla-pausa').style.display = 'none'; });

            animate();
        }

        function crearOficina() {
            officeGroup = new THREE.Group();
            mapa.forEach((row, z) => {
                row.forEach((cell, x) => {
                    if(cell === 0) {
                        const wall = new THREE.Mesh(
                            new THREE.BoxGeometry(UNIT, 40, UNIT), 
                            new THREE.MeshStandardMaterial({color: 0x111111, roughness: 0.8})
                        );
                        wall.position.set(x*UNIT, 20, z*UNIT);
                        officeGroup.add(wall);
                        wallMeshes.push(wall);
                        walls.push(new THREE.Box3().setFromObject(wall));
                    }
                });
            });

            enemy = new THREE.Mesh(new THREE.BoxGeometry(8, 18, 8), new THREE.MeshBasicMaterial({color: 0xff0000}));
            enemy.position.set(25*UNIT, 9, 25*UNIT);
            enemyLight = new THREE.PointLight(0xff0000, 5, 80);
            enemy.add(enemyLight);
            officeGroup.add(enemy);

            // Sombra final oculta
            shadowEnemy = new THREE.Mesh(new THREE.BoxGeometry(10, 25, 10), new THREE.MeshBasicMaterial({color: 0xff0000, transparent: true, opacity: 0.8}));
            shadowEnemy.visible = false;
            officeGroup.add(shadowEnemy);

            for(let i=0; i<10; i++){
                const core = new THREE.Mesh(new THREE.OctahedronGeometry(2), new THREE.MeshBasicMaterial({color: 0x00ffff}));
                let placed = false;
                while(!placed){
                    let rx = Math.floor(Math.random()*28)+1;
                    let rz = Math.floor(Math.random()*28)+1;
                    if(mapa[rz][rx] === 1){
                        core.position.set(rx*UNIT, 8, rz*UNIT);
                        items.push(core);
                        officeGroup.add(core);
                        placed = true;
                    }
                }
            }
            scene.add(officeGroup);
        }

        function createParticles() {
            for(let i=0; i<5; i++) {
                const p = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color: 0xffaa00}));
                p.position.copy(camera.position).add(new THREE.Vector3(Math.random()*100-50, -10, Math.random()*100-50));
                scene.add(p);
                fireParticles.push({mesh: p, speed: Math.random()*0.5+0.2});
            }
        }

        function updateAI() {
            if(!iaActiva || fase === 'ANIMACION_FINAL') return;
            const speed = 1.15;
            const dist = enemy.position.distanceTo(camera.position);

            let dirToPlayer = new THREE.Vector3().subVectors(camera.position, enemy.position).normalize();
            let ray = new THREE.Raycaster(enemy.position, dirToPlayer);
            let hits = ray.intersectObjects(wallMeshes);
            let canSee = dist < 220 && (hits.length === 0 || hits[0].distance > dist);

            if(canSee){
                let targetDir = new THREE.Vector3();
                if(Math.abs(dirToPlayer.x) > Math.abs(dirToPlayer.z)) targetDir.set(Math.sign(dirToPlayer.x), 0, 0);
                else targetDir.set(0, 0, Math.sign(dirToPlayer.z));
                iaVelocity.lerp(targetDir, 0.15);
            } else {
                if(Date.now() > iaTimer){
                    const angles = [0, Math.PI/2, Math.PI, -Math.PI/2];
                    iaHeading = angles[Math.floor(Math.random()*4)];
                    iaTimer = Date.now() + 1800;
                }
                iaVelocity.set(Math.sin(iaHeading), 0, Math.cos(iaHeading));
            }

            let nextX = enemy.position.clone().add(new THREE.Vector3(iaVelocity.x * speed, 0, 0));
            let nextZ = enemy.position.clone().add(new THREE.Vector3(0, 0, iaVelocity.z * speed));
            
            if(!walls.some(w => w.intersectsBox(new THREE.Box3().setFromCenterAndSize(nextX, new THREE.Vector3(10,10,10))))) enemy.position.x = nextX.x;
            if(!walls.some(w => w.intersectsBox(new THREE.Box3().setFromCenterAndSize(nextZ, new THREE.Vector3(10,10,10))))) enemy.position.z = nextZ.z;

            enemy.lookAt(enemy.position.clone().add(iaVelocity));
            if(dist < 12) { fase = 'MUERTE'; controls.unlock(); document.getElementById('pantalla-muerte').style.display = 'flex'; }
        }

        function updatePlayer() {
            if(fase === 'ANIMACION_FINAL') return;
            let speed = 1.85, move = new THREE.Vector3();
            if(keys['KeyW']) move.z -= speed; if(keys['KeyS']) move.z += speed;
            if(keys['KeyA']) move.x -= speed; if(keys['KeyD']) move.x += speed;
            move.applyQuaternion(camera.quaternion); move.y = 0;

            const pBoxX = new THREE.Box3().setFromCenterAndSize(camera.position.clone().add(new THREE.Vector3(move.x, 0, 0)), new THREE.Vector3(5,5,5));
            const pBoxZ = new THREE.Box3().setFromCenterAndSize(camera.position.clone().add(new THREE.Vector3(0, 0, move.z)), new THREE.Vector3(5,5,5));

            if(!walls.some(w => w.intersectsBox(pBoxX))) camera.position.x += move.x;
            if(!walls.some(w => w.intersectsBox(pBoxZ))) camera.position.z += move.z;

            items.forEach((item, i) => {
                if(camera.position.distanceTo(item.position) < 12){
                    officeGroup.remove(item); items.splice(i, 1);
                    fusiblesEncontrados++;
                    document.getElementById('contador').innerText = fusiblesEncontrados;
                    if(fusiblesEncontrados >= 10) startFinalSequence();
                }
            });
        }

        function startFinalSequence() {
            fase = 'ANIMACION_FINAL';
            iaActiva = false;
            enemy.visible = false;
            lantern.intensity = 0.5;
            lantern.color.setHex(0xffaa00);
            
            // Configurar sombra lateral
            let forward = new THREE.Vector3(0,0,-40).applyQuaternion(camera.quaternion);
            let side = new THREE.Vector3(50,0,0).applyQuaternion(camera.quaternion);
            shadowEnemy.position.copy(camera.position).add(forward).add(side);
            shadowEnemy.visible = true;

            setTimeout(() => {
                document.getElementById('overlay-final').style.opacity = 1;
                setTimeout(() => {
                    controls.unlock();
                    document.getElementById('pantalla-final').style.display = 'flex';
                }, 2000);
            }, 4500);
        }

        function animate() {
            requestAnimationFrame(animate);
            let time = Date.now() * 0.001;

            if(fase === 'JUEGO' && controls.isLocked){
                updateAI();
                updatePlayer();
                lantern.position.copy(camera.position);
                let tDir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                lantern.target.position.copy(camera.position).add(tDir);
            }

            if(fase === 'ANIMACION_FINAL') {
                // Efecto de fuego
                fireLight.intensity = Math.sin(time * 10) * 0.5 + 1;
                createParticles();
                fireParticles.forEach((p, i) => {
                    p.mesh.position.y += p.speed;
                    p.mesh.scale.multiplyScalar(0.98);
                    if(p.mesh.scale.x < 0.1) { scene.remove(p.mesh); fireParticles.splice(i, 1); }
                });

                // Movimiento de la sombra roja
                shadowEnemy.position.x -= Math.sin(camera.rotation.y) * 2.5;
                shadowEnemy.position.z -= Math.cos(camera.rotation.y) * 2.5;
                
                // Temblor de cámara
                camera.position.x += Math.sin(time * 50) * 0.2;
                camera.position.y += Math.cos(time * 50) * 0.2;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('keydown', (e) => keys[e.code] = true);
        window.addEventListener('keyup', (e) => keys[e.code] = false);
        window.onload = init;
    </script>
</body>
</html>