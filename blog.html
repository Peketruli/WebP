<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog - Rebeldía IN.AR</title>
    <style>
        body {
            background: linear-gradient(45deg, #FF5733, #FF8D1A, #FFC300, #FF5733);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
            color: black;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .blog-container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        input, textarea, button { margin: 5px 0; padding: 8px; width: 100%; }
        img { max-width: 300px; display: block; margin: 10px auto; }
    </style>
</head>
<body>

    <div class="blog-container">
        <h2>Crear Blog</h2>
        <input type="text" id="blogTitle" placeholder="Título del blog">
        <textarea id="blogContent" placeholder="Escribe aquí..."></textarea>
        <input type="file" id="blogMedia" accept="image/*,video/*">
        <button onclick="publishBlog()">Publicar</button>

        <div id="blogsList"></div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        function getCurrentUser() {
            return JSON.parse(localStorage.getItem("currentUser")) || { username: "Anónimo" };
        }

        async function publishBlog() {
            const title = document.getElementById("blogTitle").value.trim();
            const content = document.getElementById("blogContent").value.trim();
            const fileInput = document.getElementById("blogMedia");
            const user = getCurrentUser();

            if (!title || !content) return alert("Completa título y contenido.");

            let mediaUrl = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = `${Date.now()}_${file.name}`;
                const { error: uploadError } = await supabase.storage
                    .from('blog-media')
                    .upload(fileName, file);
                if (uploadError) return alert("Error al subir archivo: " + uploadError.message);

                const { publicURL } = supabase.storage.from('blog-media').getPublicUrl(fileName);
                mediaUrl = publicURL;
            }

            const { error } = await supabase.from("blogs").insert([
                { title, content, author: user.username, media: mediaUrl, comments: JSON.stringify([]) }
            ]);

            if (error) return alert("Error al publicar blog: " + JSON.stringify(error));

            // Mostrar el blog directamente
            const container = document.getElementById("blogsList");
            container.innerHTML = `
                <div style="text-align: center; margin-top: 20px;">
                    <h2>${title}</h2>
                    ${mediaUrl ? `<img src="${mediaUrl}" alt="Media del blog">` : ''}
                    <p style="margin-top: 10px;">${content}</p>
                </div>
            `;

            document.getElementById("blogTitle").value = "";
            document.getElementById("blogContent").value = "";
            fileInput.value = "";
        }
    </script>
</body>
