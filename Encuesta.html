<head>
    <title>Encuestas en Vivo</title>
    <style>
        body {
            background: linear-gradient(45deg, #FF5733, #FF8D1A, #FFC300, #FF5733);
            background-size: 400% 400%;
            animation: gradientBG 10s ease infinite;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            position: relative;
            margin-bottom: 100px; /* Espacio para los botones inferiores */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .poll-container, .create-poll {
            max-width: 500px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .poll-option {
            display: block;
            width: 80%;
            padding: 15px;
            margin: 10px auto;
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
        }
        .poll-option:hover {
            background-color: #ddd;
        }
        .back-button, .submit-button, .add-option-button, .delete-button {
            display: block;
            margin: 20px auto;
            padding: 15px;
            font-size: 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .back-button:hover, .submit-button:hover, .add-option-button:hover, .delete-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Encuestas en Vivo</h1>
    
    <div id="createPoll" class="create-poll" style="display: none;">
        <h2>Crear una nueva encuesta</h2>
        <input type="text" id="newQuestion" placeholder="Escribe la pregunta"><br><br>
        <div id="optionsContainer">
            <input type="text" class="option-input" placeholder="Opción 1"><br><br>
            <input type="text" class="option-input" placeholder="Opción 2"><br><br>
        </div>
        <button class="add-option-button" onclick="addOption()">Añadir Opción</button><br><br>
        <input type="number" id="duration" placeholder="Duración en segundos"><br><br>
        <button class="submit-button" onclick="createPoll()">Crear Encuesta</button>
    </div>
    
    <div class="poll-container" id="pollContainer" style="display: none;">
        <h2 id="question">Pregunta en vivo</h2>
        <div id="pollOptions"></div>
        <p id="timer">Tiempo restante: 60s</p>
        <p id="results" style="display: none;"></p>
        <button class="delete-button" id="deleteButton" style="display: none;" onclick="deletePoll()">Eliminar Encuesta</button>
    </div>
    
    <button class="back-button" onclick="goToMainPage()">Volver a Página Principal</button>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const user = JSON.parse(localStorage.getItem("currentUser"));
            const pollContainer = document.getElementById("pollContainer");
            const createPollContainer = document.getElementById("createPoll");
            const storedPoll = JSON.parse(localStorage.getItem("currentPoll"));
            
            if (user && user.email === "thunderfoll.ai@gmail.com") {
                createPollContainer.style.display = "block";
                document.getElementById("deleteButton").style.display = "block";
            }
            
            if (storedPoll) {
                document.getElementById("question").textContent = storedPoll.question;
                const pollOptions = document.getElementById("pollOptions");
                pollOptions.innerHTML = "";
                storedPoll.options.forEach((option, index) => {
                    const button = document.createElement("button");
                    button.className = "poll-option";
                    button.textContent = option.text;
                    button.onclick = () => vote(index);
                    pollOptions.appendChild(button);
                });
                pollContainer.style.display = "block";
                startTimer(storedPoll.startTime, storedPoll.duration);
            }
        });

        function addOption() {
            const optionsContainer = document.getElementById("optionsContainer");
            const optionCount = optionsContainer.getElementsByClassName("option-input").length + 1;
            const input = document.createElement("input");
            input.type = "text";
            input.className = "option-input";
            input.placeholder = `Opción ${optionCount}`;
            optionsContainer.appendChild(input);
            optionsContainer.appendChild(document.createElement("br"));
        }
        function createPoll() {
    const question = document.getElementById("newQuestion").value;
    const options = Array.from(document.getElementsByClassName("option-input")).map(input => input.value).filter(v => v);
    const duration = parseInt(document.getElementById("duration").value);

    if (!question || options.length < 2 || isNaN(duration)) {
        alert("Por favor, completa todos los campos y asegúrate de que hay al menos dos opciones.");
        return;
    }

    const startTime = Date.now();
    const pollId = `poll_${startTime}`;  // 🔹 ID único basado en el tiempo de inicio
    const pollData = { id: pollId, question, options: options.map(text => ({ text })), duration, startTime };

    // 🔹 Guardamos la nueva encuesta
    localStorage.setItem("currentPoll", JSON.stringify(pollData));

    // 🔹 Borramos todas las encuestas anteriores (opcional)
    localStorage.removeItem("previousPolls");

    // 🔹 Borrar todos los votos de la encuesta anterior
    Object.keys(localStorage).forEach(key => {
        if (key.startsWith("pollVotes_") || key.startsWith("hasVoted_")) {
            localStorage.removeItem(key);
        }
    });

    location.reload();
}

function vote(optionIndex) {
    const storedPoll = JSON.parse(localStorage.getItem("currentPoll"));
    if (!storedPoll) return;

    const pollId = storedPoll.id;  
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (!user) {
        alert("Debes iniciar sesión para votar.");
        return;
    }

    const hasVotedKey = `hasVoted_${user.email}_${pollId}`;  

    if (localStorage.getItem(hasVotedKey)) {
        alert("Solo puedes votar una vez en esta encuesta.");
        return;
    }

    localStorage.setItem(hasVotedKey, "true");  

    // 🔹 Obtener los votos actuales o inicializar si no existen
    let votes = JSON.parse(localStorage.getItem(`pollVotes_${pollId}`)) || new Array(storedPoll.options.length).fill(0);

    // 🔹 Asegurar que votes sea un array del tamaño correcto
    if (!Array.isArray(votes) || votes.length !== storedPoll.options.length) {
        votes = new Array(storedPoll.options.length).fill(0);
    }

    // 🔹 Sumar un voto a la opción seleccionada
    votes[optionIndex] += 1;
    localStorage.setItem(`pollVotes_${pollId}`, JSON.stringify(votes));

    alert("Voto registrado");
}

    const startTime = Date.now();
    const pollData = { question, options: options.map(text => ({ text })), duration, startTime };

    // Guardamos la encuesta en localStorage
    localStorage.setItem("currentPoll", JSON.stringify(pollData));

    // Eliminamos votos anteriores y la clave de "hasVoted" específica de esta encuesta
    localStorage.removeItem("pollVotes");

    // Para asegurarnos de que se borre la marca de "ya votó" de encuestas anteriores
    const user = JSON.parse(localStorage.getItem("currentUser"));
    if (user) {
        localStorage.removeItem(`hasVoted_${user.email}`); // Eliminamos la marca de voto para el usuario actual
    }

    location.reload();  // Recargamos la página para que se cargue la nueva encuesta


        function vote(optionIndex) {
            const user = JSON.parse(localStorage.getItem("currentUser"));
            if (!user) {
                alert("Por favor, inicia sesión para votar.");
                return;
            }

            const userVotedKey = `hasVoted_${user.email}`;
            const hasVoted = localStorage.getItem(userVotedKey);
            if (hasVoted) {
                alert("Ya has votado en esta encuesta.");
                return;
            }
            localStorage.setItem(userVotedKey, "true");

            let votes = JSON.parse(localStorage.getItem("pollVotes")) || [];
            votes[optionIndex] = (votes[optionIndex] || 0) + 1;
            localStorage.setItem("pollVotes", JSON.stringify(votes));
            alert("Voto registrado");
        }

        function startTimer(startTime, duration) {
            let timeLeft = duration - Math.floor((Date.now() - startTime) / 1000);
            const timerElement = document.getElementById("timer");
            const interval = setInterval(() => {
                timeLeft--;
                timerElement.textContent = `Tiempo restante: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    showResults();
                }
            }, 1000);
        }

        function showResults() {
            const resultsElement = document.getElementById("results");
            let votes = JSON.parse(localStorage.getItem("pollVotes")) || [];
            const totalVotes = votes.reduce((a, b) => a + b, 0);
            if (totalVotes === 0) {
                resultsElement.textContent = "No hubo votos.";
            } else {
                let percentages = votes.map(v => ((v / totalVotes) * 100).toFixed(1) + "%");
                let maxVotes = Math.max(...votes);
                resultsElement.innerHTML = "Resultados:<br>";
                votes.forEach((voteCount, i) => {
                    const optionButton = document.getElementsByClassName("poll-option")[i];
                    const percentage = ((voteCount / totalVotes) * 100).toFixed(1);
                    optionButton.style.backgroundColor = voteCount === maxVotes ? "#4CAF50" : "#f44336"; // Verde para el máximo, rojo para otros
                    optionButton.innerHTML = `${optionButton.textContent} - ${percentage}% (${voteCount} votos)`;
                });
                resultsElement.innerHTML += `<br>Total de votos: ${totalVotes}`;
            }
            resultsElement.style.display = "block";
        }

        function deletePoll() {
            if (confirm("¿Estás seguro de que deseas eliminar esta encuesta?")) {
                localStorage.removeItem("currentPoll");
                localStorage.removeItem("pollVotes");
                alert("Encuesta eliminada");
                location.reload();
            }
        }

        function goToMainPage() {
            window.location.href = 'PaginaPrincipal.html';
        }
    </script>
</body>
