<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chats</title>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <style>
        body {
            margin: 0; padding: 0;
            font-family: Arial, sans-serif;
            display: flex; height: 100vh;
            background: #111; color: white;
        }
        .sidebar {
            width: 25%;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            overflow-y: auto;
        }
        .chat-section {
            width: 75%;
            display: flex; flex-direction: column;
            background: rgba(20,20,20,0.9);
        }
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #444;
        }
        .chat-input {
            display: flex; padding: 10px 20px;
            border-top: 1px solid #444;
        }
        .chat-input input {
            flex-grow: 1; padding: 10px;
            border: none; border-radius: 5px;
            margin-right: 10px;
        }
        .chat-input button {
            padding: 10px 20px;
            border: none; border-radius: 5px;
            background: #008CBA; color: white;
            cursor: pointer;
        }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; }
        li:hover { background: #222; }
        .members-list { margin-top: 20px; }
        .creator { color: #FFD700; font-weight: bold; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Chats</h2>
        <button onclick="crearChat()">Crear Chat</button>
        <ul id="chat-list"></ul>

        <div class="members-list">
            <h3>Miembros</h3>
            <ul id="members-list"></ul>
        </div>
    </div>

    <div class="chat-section">
        <div class="chat-messages" id="chat-messages">
            <p>Selecciona un chat para ver los mensajes...</p>
        </div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Escribe un mensaje..." />
            <button onclick="enviarMensaje()">Enviar</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let usuario = { username: "Usuario" + Math.floor(Math.random()*1000) }; // usuario temporal
    let chatActual = null;

    // --- CARGAR CHATS ---
    async function cargarChats() {
        const { data, error } = await supabase
            .from("chats")
            .select("*")
            .order("created_at", { ascending: true });

        const chatList = document.getElementById("chat-list");
        chatList.innerHTML = "";

        if (error) { console.error(error); return; }

        data.forEach(chat => {
            const li = document.createElement("li");
            li.textContent = chat.nombre;
            li.onclick = () => abrirChat(chat);
            chatList.appendChild(li);
        });
    }

    // --- CREAR CHAT ---
    async function crearChat() {
        const nombre = prompt("Nombre del chat:");
        if (!nombre) return;

        const { data, error } = await supabase
            .from("chats")
            .insert([{ nombre, creador: usuario.username, miembros: [usuario.username] }])
            .select()
            .single();

        if (error) { alert("Error al crear chat: " + error.message); return; }

        cargarChats();
        abrirChat(data);
    }

    // --- ABRIR CHAT ---
    async function abrirChat(chat) {
        chatActual = chat;

        // Cargar miembros
        const membersUl = document.getElementById("members-list");
        membersUl.innerHTML = "";
        chat.miembros.forEach(m => {
            const li = document.createElement("li");
            li.textContent = m;
            if (m === chat.creador) li.classList.add("creator");
            membersUl.appendChild(li);
        });

        // Cargar mensajes
        const { data: mensajes, error } = await supabase
            .from("chat_messages")
            .select("*")
            .eq("chat_id", chat.id)
            .order("created_at", { ascending: true });

        const messagesDiv = document.getElementById("chat-messages");
        messagesDiv.innerHTML = "";
        if (error) { console.error(error); return; }

        mensajes.forEach(m => {
            const p = document.createElement("p");
            p.textContent = `${m.author}: ${m.message}`;
            messagesDiv.appendChild(p);
        });
    }

    // --- ENVIAR MENSAJE ---
    async function enviarMensaje() {
        const input = document.getElementById("message-input");
        const texto = input.value.trim();
        if (!texto || !chatActual) return;

        const { error } = await supabase
            .from("chat_messages")
            .insert([{ chat_id: chatActual.id, author: usuario.username, message: texto }]);

        if (error) { alert("Error al enviar mensaje: " + error.message); return; }

        input.value = "";
        abrirChat(chatActual);
    }

    // --- INICIALIZAR ---
    cargarChats();
</script>
</body>
</html>
