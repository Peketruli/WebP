<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Chats (Supabase) - Corregido</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body{margin:0;padding:0;font-family:Arial, sans-serif;display:flex;height:100vh;background:#111;color:#fff}
    .sidebar{width:25%;background:rgba(0,0,0,0.85);padding:18px;overflow-y:auto}
    .chat-section{width:75%;display:flex;flex-direction:column;background:rgba(20,20,20,0.95)}
    .chat-messages{flex:1;padding:18px;overflow:auto;border-bottom:1px solid #333}
    .chat-input{display:flex;padding:12px}
    .chat-input input{flex:1;padding:10px;border-radius:6px;border:none;margin-right:8px;background:#222;color:#fff}
    .chat-input button{padding:10px 14px;border-radius:6px;border:none;background:#0aa;color:#fff;cursor:pointer}
    ul{list-style:none;padding:0;margin:0}
    li{padding:10px;border-bottom:1px solid #222;cursor:pointer}
    li:hover{background:#222}
    .creator{color:#FFD700;font-weight:700}
    .back-button{display:block;margin-bottom:12px;padding:8px 12px;background:#ff5733;border:none;border-radius:6px;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="sidebar">
    <button class="back-button" onclick="window.location.href='PaginaPrincipal.html'">Volver a Inicio</button>

    <h2>Chats</h2>
    <button onclick="crearChat()">Crear Chat</button>
    <ul id="chat-list"></ul>

    <div style="margin-top:18px">
      <h3>Miembros</h3>
      <ul id="members-list"></ul>
    </div>
  </div>

  <div class="chat-section">
    <div class="chat-messages" id="chat-messages">
      <p>Selecciona un chat para ver los mensajes...</p>
    </div>

    <div class="chat-input">
      <input id="message-input" placeholder="Escribe un mensaje..." />
      <button onclick="enviarMensaje()">Enviar</button>
    </div>
  </div>
   
  <div id="error-log" style="color: red; font-size: 14px; margin: 10px;"></div>

<script>
/* =========  CONFIGURA ESTO  =========
   Pon aquí tu URL y ANON KEY (Settings → API en Supabase)
   Nunca uses service_role key en el frontend.
*/
const SUPABASE_URL = "https://jdvwlfogkzrzovepzjqa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdndsZm9na3pyem92ZXB6anFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMzY1MjEsImV4cCI6MjA3MzYxMjUyMX0.IwVFrvuluY0tfgE82XnqYSsRjFPsDYnlfyirHjKu1TI";

/* Inicializar cliente Supabase: usamos 'db' como cliente y lo usamos en todo el código */
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_KEY);

/* Usuario (para pruebas). Si usas login, carga desde localStorage o desde auth */
let usuario = JSON.parse(localStorage.getItem("currentUser")) || { username: "User" + Math.floor(Math.random()*1000) };

/* Estado */
let chatActual = null; // objeto chat completo cuando está abierto

/* ---------- Inicializar ---------- */
document.addEventListener("DOMContentLoaded", () => {
  console.log("Usuario:", usuario);
  cargarChats();
});

/* ---------- Cargar lista de chats ---------- */
async function cargarChats() {
    const { data: chats, error } = await supabase
        .from("chats")
        .select("*")
        .order('created_at', { ascending: true });

    const lista = document.getElementById("chat-list");
    lista.innerHTML = "";

    chats.forEach(chat => {
        const li = document.createElement("li");
        li.textContent = chat.nombre;
        li.style.cursor = "pointer";
        li.onclick = () => abrirChat(chat.id); // abrir chat al hacer click
        lista.appendChild(li);
    });
}


/* ---------- Crear chat ---------- */
async function crearChat() {
  const nombre = prompt("Nombre del chat:");
  if (!nombre) return;

  // asegurar usuario válido
  if (!usuario || !usuario.username) {
    alert("No hay usuario. Guarda currentUser en localStorage o inicia sesión.");
    return;
  }

  try {
    const { data, error } = await db
      .from("chats")
      .insert([{
        nombre,
        creador: usuario.username,
        miembros: [usuario.username] // array -> text[] en PG
      }])
      .select() // pedimos que devuelva lo insertado
      .single();

    if (error) throw error;

    // recargar lista y abrir el chat recién creado
    await cargarChats();
    abrirChat(data.id);
  } catch (err) {
    console.error("crearChat error:", err);
    alert("Error al crear chat: " + (err.message || err));
  }
}

/* ---------- Abrir chat (recupera el chat desde DB) ---------- */
async function abrirChat(chatId) {
  try {
    // obtener chat actualizado
    const { data: chatData, error: chatErr } = await db
      .from("chats")
      .select("*")
      .eq("id", chatId)
      .single();

    if (chatErr) throw chatErr;

    chatActual = chatData; // guardamos el objeto completo

    // mostrar miembros
    const membersUl = document.getElementById("members-list");
    membersUl.innerHTML = "";
    const miembros = Array.isArray(chatData.miembros) ? chatData.miembros : [];
    if (miembros.length === 0) {
      const li = document.createElement("li");
      li.textContent = "(sin miembros)";
      membersUl.appendChild(li);
    } else {
      miembros.forEach(m => {
        const li = document.createElement("li");
        li.textContent = m;
        if (m === chatData.creador) li.classList.add("creator");
        membersUl.appendChild(li);
      });
    }

    // cargar mensajes
    await cargarMensajes(chatData.id);

  } catch (err) {
    console.error("abrirChat error:", err);
    alert("Error abriendo chat. Mira la consola.");
  }
}

/* ---------- Cargar mensajes para un chat ---------- */
async function cargarMensajes(chatId) {
  try {
    const { data: mensajes, error } = await db
      .from("chat_messages")
      .select("*")
      .eq("chat_id", chatId)
      .order("created_at", { ascending: true });

    if (error) throw error;

    const container = document.getElementById("chat-messages");
    container.innerHTML = "";

    if (!mensajes || mensajes.length === 0) {
      container.innerHTML = "<p>No hay mensajes (escribe el primero).</p>";
      return;
    }

    mensajes.forEach(m => {
      const p = document.createElement("p");
      const time = new Date(m.created_at).toLocaleString();
      p.textContent = `${m.author} — ${time}: ${m.message}`;
      container.appendChild(p);
    });

    container.scrollTop = container.scrollHeight;
  } catch (err) {
    console.error("cargarMensajes error:", err);
    alert("Error cargando mensajes. Revisa la consola.");
  }
}

/* ---------- Enviar mensaje ---------- */
async function enviarMensaje() {
  const input = document.getElementById("message-input");
  const texto = input.value.trim();
  if (!texto) return;
  if (!chatActual || !chatActual.id) {
    alert("Selecciona un chat antes de enviar un mensaje.");
    return;
  }

  try {
    const { error } = await db
      .from("chat_messages")
      .insert([{
        chat_id: chatActual.id,
        author: usuario.username,
        message: texto
      }]);

    if (error) throw error;

    input.value = "";
    // recargamos solo los mensajes (más eficiente que recargar toda la lista)
    await cargarMensajes(chatActual.id);
  } catch (err) {
    console.error("enviarMensaje error:", err);
    alert("Error al enviar mensaje: " + (err.message || err));
  }
}

</script>
</body>
</html>
